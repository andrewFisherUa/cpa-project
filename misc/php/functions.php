<?php

/**
* @param string $page_scripts Содержит скрипты страницы
**/

$page_scripts = [
    "/ckeditor/ckeditor.js",
    "/misc/js/jquery.mask.min.js",
    "/misc/js/univer.js",
    "/assets/global/plugins/bootstrap/js/bootstrap.min.js",
    "/assets/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js",
    "/assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js",
    "/assets/global/plugins/jquery.cokie.min.js",
    "/assets/global/plugins/jquery.blockui.min.js",
    "/assets/global/plugins/uniform/jquery.uniform.min.js",
    "/assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js",
    "/assets/global/scripts/app.min.js",
    "/assets/pages/scripts/table-datatables-responsive.min.js",
    "/assets/layouts/layout2/scripts/layout.min.js",
    "/assets/layouts/layout2/scripts/demo.min.js",
    "/assets/layouts/global/scripts/quick-sidebar.min.js",
    "/assets/global/plugins/bootstrap-toastr/toastr.min.js",
    "/assets/pages/scripts/ui-toastr.min.js",
];

$page_styles = [
    "home" => [
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "admin_statistics" => [
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "statistics" => [
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "offers" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/misc/fancybox/source/jquery.fancybox.css",
        "/misc/fancybox/source/helpers/jquery.fancybox-thumbs.css",
        "/assets/global/plugins/jstree/dist/themes/default/style.min.css"
    ],
    "offer_stat_index" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "cats" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
    ],
    "groups" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "landings" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "blogs" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "flows" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "api" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "spaces" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "balance" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "trasfer" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css"
    ],
    "orders" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
    ],
    "bad_orders" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
    ],
    "exchange_rates" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
    ],
    "balance_operations" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
    ],
    "news" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
        "/assets/global/plugins/bootstrap-summernote/summernote.css"
    ],
    "users" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
        "/assets/global/plugins/bootstrap-editable/bootstrap-editable/css/bootstrap-editable.css",
    ],
    "hold" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
    ],
    "roles" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
    ],
    "refs" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "navigation" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
    ],
    "tickets" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-toastr/toastr.css",
    ],
    "admin-faq" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
        "/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css",
    ],
    "user" => [
        "/assets/global/plugins/select2/css/select2.min.css",
        "/assets/global/plugins/select2/css/select2-bootstrap.min.css",
    ],
    "profile" => [
        "/assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css",
        "/assets/pages/css/profile.css",
    ],
    "refs" => [
        "/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css",
    ],
];


/**
* @param string $page_scripts Содержит стили страницы
**/
$global_styles = [
    "//fonts.googleapis.com/css?family=Open+Sans:400,400italic,600,600italic,300,300italic,700,700italic&subset=latin,cyrillic,cyrillic-ext",
    "/assets/global/plugins/font-awesome/css/font-awesome.min.css",
    "/assets/global/plugins/simple-line-icons/simple-line-icons.min.css",
    "/assets/global/plugins/bootstrap/css/bootstrap.min.css",
    "/assets/global/plugins/uniform/css/uniform.default.css",
    "/misc/css/flags.css",
    "/assets/global/css/components-1.min.css",
    "/assets/global/css/components-2.min.css",
    "/assets/global/css/plugins.css",
    "/assets/layouts/layout2/css/layout.css",
    "/assets/layouts/layout2/css/themes/blue.css",
    "/assets/layouts/layout2/css/custom.css",
    "/misc/css/admin/admin.css",
    "/assets/global/plugins/bootstrap-toastr/toastr.css"
];

/**
 * Выводит подключенные к странице стили
 *
 * @return void
 **/
function get_stylesheets($component) {
    global $global_styles, $page_styles;

    if (array_key_exists($component, $page_styles)) {
        $styles = array_merge($page_styles[$component], $global_styles);
    } else {
        $styles = $global_styles;
    }

    foreach ( $styles as $style ) {
        echo "<link rel='stylesheet' type='text/css' href='{$style}' />\r\n";
    }
}

/**
 * Generate a random salt in the crypt(3) standard Blowfish format.
 *
 * @param int $cost Cost parameter from 4 to 31.
 *
 * @throws Exception on invalid cost parameter.
 * @return string A Blowfish hash salt for use in PHP's crypt()
 **/

function blowfishSalt($cost = 13) {
    if (!is_numeric($cost) || $cost < 4 || $cost > 31) {
        throw new Exception("cost parameter must be between 4 and 31");
    }
    $rand = array();
    for ($i = 0; $i < 8; $i += 1) {
        $rand[] = pack('S', mt_rand(0, 0xffff));
    }
    $rand[] = substr(microtime(), 2, 6);
    $rand = sha1(implode('', $rand), true);
    $salt = '$2a$' . sprintf('%02d', $cost) . '$';
    $salt .= strtr(substr(base64_encode($rand), 0, 22), array('+' => '.'));
    return $salt;
}


function array_column($arr, $key){
    $result = array();
    if ( !empty( $arr ) ) {
        foreach ( $arr as $val ) {
            $result[] = $val[$key];
        }
    }
    return $result;
}


/**
 * Возвращает URL сайта
 *
 * @return string
 **/
function get_site_url() {
    return SITE_URL;
}

/**
 * Возвращает URL административной панели
 *
 * @return string
 */
function get_admin_url() {
    return get_site_url() . '/admin';
}

/**
 * Автоматически подключает классы с именем $className
 *
 * @return void
 **/
function autoloader($className) {
    include_once PATH_ROOT . DS . 'objects' . DS . $className . '.php';
}

/**
 * Подключает скрипты к странице
 *
 * @return void
 **/
function enqueue_scripts( $paths = array() ) {
    global $page_scripts;
    if ( !empty($paths) ) {
        foreach( $paths as $path ) {
            $page_scripts[] = $path;
        }
    }
}

/**
 * Выводит подключенные к странице скрипты
 *
 * @return void
 **/
function get_scripts() {
    global $page_scripts;

    foreach ( $page_scripts as $script ) {
        echo "<script src='{$script}'></script>\r\n";
    }
}

/**
* Удаляет каталог и все содержащиеся в нем файлы и каталоги
*
* @param string $directory Путь к каталогу
*/

function recursive_remove_dir($directory) {
    foreach(glob("{$directory}/*") as $file) {
        if (is_dir($file)) {
            recursive_remove_dir($file);
        } else {
            unlink($file);
        }
    }
    rmdir($directory);
}

function get_pagination( $link, $page, $total ) {
    if ( $page < 1 ) {
        $page = 1;
    }

    $prevClass = ""; $nextClass = "";

    $prevPage = $page-1;
    $nextPage = $page+1;

    if ( $page == 1 ) {
        $prevClass = "disabled";
        $prevLink = "javascript:;";
    } else {
        $prevLink = "{$link}/{$prevPage}";
    }

    if ( $page >= $total ) {
        $nextClass = "disabled";
        $nextLink = "javascript:;";
    } else {
        $nextLink = "{$link}/{$prevPage}";
    }

    $prevClass = ( $page == 1 ) ? "disabled" : "";
    $nextClass = ( $page >= $total ) ? "disabled" : "";


    $links = "<ul class='pagination'>
                <li class='prev {$prevClass}'>
                  <a href='{$prevLink}'><i class='fa fa-angle-left'></i></a>
                </li>";

    for ( $i=1; $i<=$total; $i++ ) {
        $activePage = ( $i == $page ) ? "active" : "";
        $links .= "<li class='{$activePage}'><a href='{$link}/{$i}'>{$i}</a></li>";
    }


    if ($total > 1) {
        return $links .= "<li class='next {$nextClass}'>
                             <a href='{$nextLink}'><i class='fa fa-angle-right'></i></a>
                          </li>
                          </ul>";
    }
    
    return "";
}

function time_elapsed_string($ptime){
    $etime = time() - $ptime;

    if($etime < 1){
      return '0 секунд';
    }

    $a = array(
      365 * 24 * 60 * 60 => 'год',
      30 * 24 * 60 * 60 => 'месяц',
      24 * 60 * 60 => 'день',
      60 * 60 => 'час',
      60 => 'минута',
      1 => 'секунда'
    );

    $a_plural = array(
      'год' => 'года',
      'месяц' => 'месяця',
      'день' => 'дня',
      'час' => 'часа',
      'минута' => 'минуты',
      'секунда' => 'секунды'
    );
    $b_plural = array(
      'год' => 'лет',
      'месяц' => 'месяцев',
      'день' => 'дней',
      'час' => 'часов',
      'минута' => 'минут',
      'секунда' => 'секунд'
    );

    foreach($a as $secs => $str){
      $d = $etime / $secs;
      if($d >= 1){
        $r = floor($d);
        switch($r){
          case $r == 1 || $r == 21:
            $output = $r . ' ' . $str . ' назад';
            break;
          case $r >= 2 && $r <= 4:
            $output = $r . ' ' . $a_plural[$str] . ' назад';
            break;
          case $r >= 5 && $r <= 20:
            $output = $r . ' ' . $b_plural[$str] . ' назад';
            break;
          case $r >= 22 && $r <= 24:
            $output = $r . ' ' . $a_plural[$str] . ' назад';
            break;
          default:
            $output = $r . ' ' . $b_plural[$str] . ' назад';
        }
        return $output;
      }
    }
}

function sortByColumn($a, $order="asc", $n = 0) {

    $length = count($a);

    for ($j = 0; $j < $length-1; $j++) {
         for ($i = 0; $i < $length-$j-1; $i++) {
             if ($order == "desc" && $a[$i][$n] > $a[$i+1][$n]) {
                 $b = $a[$i]; //change for elements
                 $a[$i] = $a[$i+1];
                 $a[$i+1] = $b;
             }

             if ($order == "asc" && $a[$i][$n] < $a[$i+1][$n]) {
                 $b = $a[$i]; //change for elements
                 $a[$i] = $a[$i+1];
                 $a[$i+1] = $b;
             }
        }
    }

    return $a;
}

function round_val($val) {
    $p = 4;

    return round($val, $p);
}

function take_script($data = array(), $url) {
    $hash    = md5( date( 'Y-m-d' ).'pathfinder'.date( 'Y-m-d' ) );
    $site_id = $data['site_id'];
    $user_id = $data['user_id'];
    $goal_url = $data['goal_url'];

    $url = "http://s.umseller.com";

    $url_api = "http://umag.p-finder.org/api_connect/?action=get_script";
    if ( $curl = curl_init() ) {
        curl_setopt( $curl, CURLOPT_CONNECTTIMEOUT, 60 );
        curl_setopt( $curl, CURLOPT_URL, $url_api );
        curl_setopt( $curl, CURLOPT_RETURNTRANSFER, true );
        curl_setopt( $curl, CURLOPT_POST, true );
        curl_setopt( $curl, CURLOPT_POSTFIELDS, "hash=$hash&site_id=$site_id&user_id=$user_id&url=$url&goal_url=$goal_url" );
        $out = curl_exec( $curl );
        curl_close( $curl );
        return $out;
    }
    return 'error';
}

function get_admin_notifications(){
    $messages = [];
    $today = mktime(0, 0, 0, date("n"), date("j"), date("Y"));

    // новые пользователи
    $query = "SELECT count(*) 
              FROM users AS u INNER JOIN user_role AS ur ON u.user_id = ur.user_id
              WHERE u.status = 1 AND ur.role_id = 2 AND u.created > " . $today;
    $stmt = $GLOBALS['DB']->query($query);
    $new_users = $stmt->fetchColumn();
    if ($new_users > 0){
        $messages[] = [
            "page" => "/admin/users/",
            "message" => "Пользователи на модерации - " . $new_users
        ];
    }

    // запросы на выплату
    $query = "SELECT t1.login, t1.user_id, t2.amount, t2.currency, t2.payment_id
              FROM users as t1 inner join payments as t2 ON t1.user_id = t2.user_id
              WHERE t2.status = 'moderation' AND t2.created > " . $today;
    $stmt = $GLOBALS['DB']->query($query);
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $messages[] = [
            "page" => "/admin/payments/" . $row["payment_id"],
            "message" => "Запрос на выплату от " . $row['user_id'] . ": " . $row['login'] . " - " . $row['amount'] . "&nbsp" . $row['currency']
        ];
    }

    // запросы на изменение валюты
    $query = "SELECT t1.login, t1.user_id, t2.currency as `to`, t2.default_currency as `from`
              FROM users as t1 inner join account_currency as t2 on t1.user_id = t2.user_id
              WHERE t2.status = 'processing' AND t2.created > " . $today;
    $stmt = $GLOBALS['DB']->query($query);
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $messages[] = [
            "page" => "/admin/users/balance#requests",
            "message" => "Запрос на изменение валюты от " . $row['user_id'] . ": " . $row['login'] . " - " . $row['from'] . " > " . $row['to']
        ];
    }

    // источники трафика
    $stmt = $GLOBALS['DB']->query("SELECT count(*) FROM spaces WHERE status = 'processing' AND created > " . $today);
    $new_spaces = $stmt->fetchColumn();
    if ($new_spaces > 0){
        $messages[] = [
            "page" => "/admin/spaces",
            "message" => "Источники трафика на модерации - " . $new_spaces
        ];
    }

    
    $time = time();
    $query = "SELECT title, activate_time FROM news WHERE status = " . News::STATUS_ACTIVE . " AND activate_time - {$time} < 3600";
    $stmt = $GLOBALS['DB']->query($query);
    while ($a = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $m = ceil(($a['activate_time']-$time)/60);
        $messages[] = [
            "page" => "/admin/news",
            "message" => "Активация рассылки новости `" . $a['title'] . "` через " . $m . " мин."
        ];
    }


    // Курс валют
    $query = "SELECT end, `from`, `to` FROM special_exchange_rates WHERE status = " . Converter::STATUS_APPROVED . " AND end > {$time} AND end - {$time} < 86400";
    $stmt = $GLOBALS['DB']->query($query);
    while ($a = $stmt->fetch(PDO::FETCH_ASSOC)) {

        $timeLeft = $a["end"] - $time;
        $timeLeft_label = "";
        if ($time < 60) {
            $timeLeft_label = $timeLeft . " сек.";
        }

        if ($time > 60 && $time < 3600) {
            $timeLeft_label = floor($timeLeft / 60) . " мин.";
        }

        if ($time > 3600) {
            $timeLeft_label = floor($timeLeft / 3600) . " час.";
        }

        $messages[] = [
            "page" => "/admin/exchange_rates",
            "message" => "Действие курса `" . $a['from'] . "/" . $a["to"] ."` закончится через " . $timeLeft_label
        ];
    }

    return $messages;
}



function getProfit($parent_id, $referal_id, $to_currency){
  $query = "SELECT sum(t2.amount) as amount, country_code
            FROM orders as t1 INNER JOIN order_refprofit as t2 ON t1.id = t2.order_id
            WHERE t1.user_id = :referal_id AND t2.user_id = :parent_id AND t2.hold = 0
            GROUP BY t1.country_code";

  $stmt = $GLOBALS['DB']->prepare($query);
  $stmt->bindParam(":referal_id", $referal_id, PDO::PARAM_INT);
  $stmt->bindParam(":parent_id", $parent_id, PDO::PARAM_INT);
  $stmt->execute();

  $amount = 0;

  if ($stmt->rowCount() > 0) {
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
      $currency = Country::getCurrencyCode($row['country_code']);
      $temp = Converter::getConvert($currency, $to_currency, $row['amount']);
      $amount += $temp['amount'];
    }
  }

  return round($amount);
}

function getReferals($user_id){
  $query = "SELECT t1.user_id as id, t1.login, t1.created FROM users as t1 INNER JOIN partners as t2 ON t1.user_id = t2.id WHERE t2.sub = ?";
  $stmt = $GLOBALS['DB']->prepare($query);
  $stmt->execute([$user_id]);
  if ($stmt->rowCount() > 0) {
    $items = [];
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
      $items[$row['id']]['login'] = $row['login'];
      $items[$row['id']]['parent'] = $user_id;
      $items[$row['id']]['created'] = date("d.m.Y H:i", $row['created']);
    }
    return $items;
  }

  return null;
}

function getUnreadTicketMessages($user_id) {
    $messages = [];

    $query = "SELECT message, ticket_id, created
              FROM tickets_messages
              WHERE to_uid = " . $user_id . " AND seen = 0
              ORDER BY created DESC";
    $stmt = $GLOBALS['DB']->query($query);
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {

        $m = $row['message'];
        if (iconv_strlen($m, "UTF-8") > 50) {
            $o = iconv_strpos($row['message'], " ", 50, "UTF-8");
            $m = iconv_substr($row['message'], 0, $o, "UTF-8");
            $m .= " ... ";
        }

        $messages[] = [
            "text" => $m,
            "ticket_id" => $row['ticket_id'],
            "created" => time_elapsed_string($row['created']),
        ];
    }

    return $messages;
}

function render($path) {
    require_once $_SERVER['DOCUMENT_ROOT'] . "/templates/admin/" . $path . '.php';
}

function getTotalReferalsCount($uid){
    $count = 0;

    // 1 уровень
    $level1 = getReferalsCount($uid);

    if (count($level1)) {
        foreach ($level1 as $a) {
            $count++;

            // 2 уровень
            $level2 = getReferalsCount($a);
            if (count($level2)) {
                foreach ($level2 as $b) {
                    $count++;

                    // 3 уровень 
                    $count += count(getReferalsCount($b));
                }
            }
        }
    }

    return $count;
}

function getReferalsCount($uid){
    $query = "SELECT id FROM partners WHERE sub = ?";
    $stmt = $GLOBALS['DB']->prepare($query);
    $stmt->execute([$uid]);
    return $stmt->fetchAll(PDO::FETCH_COLUMN);
}

function accept_api_key($hash){
    $db = new PDO('mysql:host=188.165.5.44;dbname=umagapi', 'umagapi', 'SsLwu3VcqutqzcAs');

    $query = "INSERT INTO access_hash VALUES (?)";
    $stmt = $db->prepare($query);
    $stmt->execute([
        $hash
    ]);
}

function refuse_api_key($hash){
    $db = new PDO('mysql:host=188.165.5.44;dbname=umagapi', 'umagapi', 'SsLwu3VcqutqzcAs');

    $query = "DELETE FROM access_hash WHERE hash = ?";
    $stmt = $db->prepare($query);
    $stmt->execute([
        $hash
    ]);
}

function get_api_url(){
    return API_URL;
}

function change_api_key_status($uid, $status) {
    $errors = [];

    $stmt = $GLOBALS['DB']->prepare("SELECT hash, ticket_id, status FROM api_requests WHERE user_id = ?");
    $stmt->execute([$uid]);
    $api_key = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($api_key["status"] == "accepted" && $status == "accepted") {
        $errors[] = "Запрос уже был одобрен.";
    }

    if ($api_key["status"] == "refused" && $status == "refused") {
        $errors[] = "Запрос уже был отклонен.";
    }

    if (!empty($errors)) {
        return $errors;
    }

    if (in_array($status, ["accepted", "refused"])) {
        // Меняем статус заявки
        $query = "UPDATE api_requests SET status = :status, changed = " . time() . " WHERE user_id = :uid";
        $stmt = $GLOBALS['DB']->prepare($query);
        $stmt->bindParam(":status", $status, PDO::PARAM_STR);
        $stmt->bindParam(":uid", $uid, PDO::PARAM_INT);
        if ($stmt->execute()) {

            // Отписываемся в тикете для пользователя
            if ($status == "accepted") {
                $link =  get_api_url() . "/help?hash=" . $api_key['hash'];
                $message = "Запрос одобрен!<br/>";
                $message .= "Ваш ключ: " . $api_key['hash'] . ".<br/>API доступно по ссылке: <a href='{$link}' target='_blank'>{$link}</a><br/>";
                $message .= "Ссылка на API также доступна в <a href='" . get_site_url() . "/admin/profile'>профиле</a> на вкладке API.</br>";

                accept_api_key($api_key['hash']);
            } else {
                $message = "Запрос отклонен.";

                refuse_api_key($api_key['hash']);
            }

            $message = new TicketMessage([
                "from_uid" => 0,
                "to_uid" => $uid,
                "message" => $message,
                "ticket_id" => $api_key['ticket_id'],
            ]);

            $message->save();

            Ticket_UPD::sendEmail(Ticket_UPD::getInstance($api_key['ticket_id']), "new_message");

        } else {
            $errors[] = "Произошла ошибка.";
        }
    } else {
        $errors[] = "Некорректый статус.";
    }

    if (empty($errors)) {
        return true;
    }

    return $errors;
}

function get_support_notifications(){
    $messages = [];
    $today = mktime(0, 0, 0, date("n"), date("j"), date("Y"));

    // новые пользователи
    $query = "SELECT count(*) 
              FROM partners AS p INNER JOIN user_role AS ur ON p.id = ur.user_id
                                 INNER JOIN users AS u ON u.user_id = ur.user_id
              WHERE p.skype_status = 0 AND u.status = 2 AND ur.role_id = 2";
    $stmt = $GLOBALS['DB']->query($query);
    $new_users = $stmt->fetchColumn();
    if ($new_users > 0){
        $messages[] = [
            "page" => "/admin/users/",
            "message" => "Пользователи на модерации - " . $new_users
        ];
    }

    return $messages;
}

function get_bad_orders_count() {
    $stmt = $GLOBALS["DB"]->query("SELECT count(id) FROM orders WHERE status_problem_time > 0");
    return $stmt->fetchColumn();
}

function get_ref_link($uid){
    return get_site_url() . "/?ref=" . $uid;
}

function get_registration_ref_link($uid){
    return get_site_url() . "/registration/?ref=" . $uid;
}

function get_default_currency(){
    return "RUB";
}